---
title: "Differential Expression"
author: "Nadine Bestard"
date: "21/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### set-up
```{r}
library(scran) # for scDE
library(scater) # for aggregate counts
library(edgeR) #for De
library(here) # reproducible paths
```
```{r load}
project <- "fire-mice"
sce <- readRDS(here("processed", project, "sce_oligo_clusters_01.RDS")) 
```


## Use of pseudo-bulk samples

We perform the DE analysis separately for each label to identify cell type-specific transcriptional effects of KO condition. The actual DE testing is performed on “pseudo-bulk” expression profiles (Tung et al. 2017), generated by summing counts together for all cells with the same combination of label and sample. This leverages the resolution offered by single-cell technologies to define the labels, and combines it with the statistical rigor of existing methods for DE analyses involving a small number of samples.

```{r sum}
# each column represents unique combination for cluster_oligo and each sample replicate
summed <- aggregateAcrossCells(sce, 
    id=colData(sce)[,c("cluster_oligo", "Sample")]) ### change cluster_oligo by whatever resolution
summed
```

## Perform DE

We first filter all the combinations sample-label that resulted in less than 10
cells. These are saved in /outs/`r project`/DE_oligo_cluster/fail_min_cells_DE.csv

```{r filter-summed}
# Removing all pseudo-bulk samples with 'insufficient' cells.
summed_filt <- summed[, summed$ncells >= 10]

# and saving to file which one there are
fail_n_cells  <- colData(summed)[ colData(summed)$ncells < 10, c("Sample", "mouse", "genotype", "tissue", "chip", "cluster_oligo", "ncells")]
write.csv(fail_n_cells, here("outs", project,"DE_oligo_cluster", "fail_min_cells_DE.csv"), row.names = FALSE)
```

We then compute the DE with edgeR, one of the best methods according to [(Soneson et al. 2018)](https://www.nature.com/articles/nmeth.4612). The results are saved in /outs/`r project`/DE_oligo_cluster/de_results

**Output:**

LogFC is the log fold-change, which is the log difference between both groups

LogCPM are the log counts per million, which can be understood as measuring expression level.

F is the F-statistic from the quasi-likelihood F-test.

PValue is the nominal p-value derived from F without any multiple testing correction

FDR (False discovery rate) is the PValue after Benjamini-Hochberg correction.  For example, the set of genes with adjusted p value less than 0.1 should contain no more than 10% false positives.

If the comparison was not possible for a particular cluster, most commonly due to lack of residual degrees of freedom ( e.g. an absence of enough samples from both conditions) it is listed in /outs/`r project`/DE_oligo_cluster/fail_min_cells_DE.csv

```{r de}
# Reordering the genotype factor, treated should be second level
summed_filt$genotype <- factor(summed_filt$genotype, levels = c("WT", "KO"))

# run de
de_results <- pseudoBulkDGE(summed_filt, 
    label=summed_filt$cluster_oligo,
    design= ~factor(chip) + genotype,
    coef="genotypeKO",
    condition=summed_filt$genotype 
)

# save result
saveRDS(de_results, here("processed",project, "DE_oligo_cluster_de_results.RDS"))
lapply(names(de_results), function(x){
  de_results_clu <- de_results[[x]]
  write.csv(de_results_clu, here("outs", project, "DE_oligo_cluster", "de_results", paste0("de_results_", x, ".csv")), quote = FALSE)
}
)

# save fail
write.csv(metadata(de_results), here("outs", project,"DE_oligo_cluster", "fail_contrast_DE.csv"), row.names = FALSE)

```

## Filter the results

For each one of the labels a list is produced with the DE genes at a FDR of 5%. Summaries of these results are saved in /outs/`r project`/DE_oligo_cluster/ 

Values of 1, -1 and 0 indicate that the gene is significantly upregulated, downregulated or not significant, respectively.
Genes listed as NA were either filtered out as low-abundance genes for a given label’s analysis, or the comparison of interest was not possible for that particular label.

de_filtered_genecounts.csv contains a small summary with the number of genes DE for each one of the clusters. 

de_filtered_genes.csv contains the list of genes DE. 

```{r filter-de}
is_de <- decideTestsPerLabel(de_results, threshold=0.05)
summary_de <- summarizeTestsPerLabel(is_de)

# virtually 0 or NA we do not care, we want only + or -
is_de_0 <- is_de
is_de_0[is.na(is_de_0)]<- 0
# but filter the original object to get them back
is_de_flt <- is_de[(rowSums(abs(is_de_0)) != 0), ]

write.csv(summary_de, here("outs", project,"DE_oligo_cluster", "de_filtered_genecounts.csv"))

write.csv(is_de_flt, here("outs", project, "DE_oligo_cluster", "de_filtered_genes.csv" ))
```

## Plot the results

Saved in /outs/`r project`/DE_oligo_cluster/de_filtered_plots

```{r, eval=FALSE}
is_de_genes <- rownames(is_de_flt)
for( gene in is_de_genes){
pdf(file = here("outs", project, "DE_oligo_cluster", "de_filtered_plots", paste0(gene, ".pdf")))
plot <- plotExpression(logNormCounts(sce),
    features=gene,
    x="genotype", colour_by="genotype",
    other_fields="cluster_oligo") +
    facet_wrap(~cluster_oligo) +
    scale_color_manual(values = c("#666666", "#E25822")) +
    ggtitle(gene)
print(plot)
dev.off()
}
```